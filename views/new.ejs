<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        <%= title %>
    </title>
    <link rel="stylesheet" href="/stylesheets/form.css">
</head>

<body>
    <div class="container">
        <h1>‚úçÔ∏è New Message</h1>

        <div class="form-container">
            <h2 class="form-title">Share your thoughts</h2>

            <!-- Error Messages Section -->
            <% if (locals.errors && errors.length> 0) { %>
                <div class="error-container">
                    <h3>‚ö†Ô∏è Please fix the following errors:</h3>
                    <ul class="error-list">
                        <% errors.forEach(error=> { %>
                            <li class="error-item">
                                <%= error.msg %>
                            </li>
                            <% }); %>
                    </ul>
                </div>
                <% } %>

                    <form method="POST" action="/new" id="messageForm">
                        <div class="form-group">
                            <label for="username">üë§ Your Name:</label>
                            <input type="text" id="username" name="username" placeholder="Enter your name..."
                                value="<%= locals.formData ? formData.username || '' : '' %>" required maxlength="50"
                                class="<%= locals.errors && errors.some(err => err.path === 'username') ? 'error' : '' %>" />
                        </div>

                        <div class="form-group">
                            <label for="text">üí≠ Your Message:</label>
                            <textarea id="text" name="text" rows="5"
                                placeholder="What's on your mind? Share your thoughts with the community..." required
                                maxlength="500"
                                class="<%= locals.errors && errors.some(err => err.path === 'text') ? 'error' : '' %>">
                                <%= locals.formData ? formData.text || '' : '' %>
                            </textarea>
                            <div class="char-counter">
                                <span id="charCount">0</span>/500 characters
                            </div>
                        </div>

                        <button type="submit" class="submit-btn" id="submitBtn">
                            üì§ Send Message
                        </button>
                    </form>

                    <a href="/" class="back-link">‚Üê Back to all messages</a>
        </div>
    </div>

    <script>
        // Character counter
        const textarea = document.getElementById('text');
        const charCount = document.getElementById('charCount');

        // Set initial count
        charCount.textContent = textarea.value.length;

        textarea.addEventListener('input', function () {
            const count = this.value.length;
            charCount.textContent = count;

            // Auto-resize textarea
            this.style.height = 'auto';
            this.style.height = this.scrollHeight + 'px';

            // Change color based on character count
            if (count > 450) {
                charCount.style.color = '#e74c3c';
            } else if (count > 400) {
                charCount.style.color = '#f39c12';
            } else {
                charCount.style.color = '#888';
            }
        });

        // Form submission with loading state
        document.getElementById('messageForm').addEventListener('submit', function (e) {
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.innerHTML;

            submitBtn.innerHTML = '<span class="loading"></span> Sending...';
            submitBtn.disabled = true;

            // Re-enable button if form submission fails (fallback)
            setTimeout(() => {
                if (submitBtn.disabled) {
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }
            }, 5000);
        });

        // Focus first input on load (unless there's an error, focus the error field)
        window.addEventListener('load', function () {
            const errorInput = document.querySelector('input.error, textarea.error');
            if (errorInput) {
                errorInput.focus();
            } else {
                document.getElementById('username').focus();
            }
        });
    </script>
</body>

</html>
